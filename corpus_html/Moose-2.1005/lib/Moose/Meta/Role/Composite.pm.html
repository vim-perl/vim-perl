<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
 <head>
  <title>[untitled]</title>
  <link rel="stylesheet" type="text/css" href="../../t/vim_syntax.css" />
 </head>
 <body>

<pre><span class="synStatement">package</span><span class="synType"> Moose::Meta::Role::Composite</span>;
<span class="synPreProc">BEGIN </span>{
  <span class="synIdentifier">$</span><span class="synType">Moose::Meta::Role::Composite::</span><span class="synIdentifier">AUTHORITY</span> = <span class="synString">'cpan:STEVAN'</span>;
}
{
  <span class="synIdentifier">$</span><span class="synType">Moose::Meta::Role::Composite::</span><span class="synIdentifier">VERSION</span> = <span class="synString">'2.1005'</span>;
}

<span class="synStatement">use strict</span>;
<span class="synStatement">use warnings</span>;
<span class="synStatement">use </span>metaclass;

<span class="synStatement">use </span>Class::Load <span class="synString">qw(load_class)</span>;
<span class="synStatement">use </span>Scalar::Util <span class="synString">'blessed'</span>;

<span class="synStatement">use base</span> <span class="synString">'Moose::Meta::Role'</span>;

<span class="synComment"># </span><span class="synTodo">NOTE:</span>
<span class="synComment"># we need to override the -&gt;name</span>
<span class="synComment"># method from Class::MOP::Package</span>
<span class="synComment"># since we don't have an actual</span>
<span class="synComment"># package for this.</span>
<span class="synComment"># - SL</span>
__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;add_attribute</span>(<span class="synString">'name'</span> =&gt; (
    <span class="synString">reader</span> =&gt; <span class="synString">'name'</span>,
    Class::MOP::_definition_context(),
));

<span class="synComment"># </span><span class="synTodo">NOTE:</span>
<span class="synComment"># Again, since we don't have a real</span>
<span class="synComment"># package to store our methods in,</span>
<span class="synComment"># we use a HASH ref instead.</span>
<span class="synComment"># - SL</span>
__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;add_attribute</span>(<span class="synString">'_methods'</span> =&gt; (
    <span class="synString">reader</span>  =&gt; <span class="synString">'_method_map'</span>,
    <span class="synString">default</span> =&gt; <span class="synKeyword">sub </span>{ {} },
    Class::MOP::_definition_context(),
));

__PACKAGE__<span class="synIdentifier">-&gt;meta-&gt;add_attribute</span>(
    <span class="synString">'application_role_summation_class'</span>,
    <span class="synString">reader</span>  =&gt; <span class="synString">'application_role_summation_class'</span>,
    <span class="synString">default</span> =&gt; <span class="synString">'Moose::Meta::Role::Application::RoleSummation'</span>,
    Class::MOP::_definition_context(),
);

<span class="synKeyword">sub </span><span class="synFunction">new </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$class</span>, <span class="synIdentifier">%params</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># the roles param is required ...</span>
    <span class="synRepeat">foreach</span> ( <span class="synIdentifier">@{$params{</span><span class="synString">roles</span><span class="synIdentifier">}}</span> ) {
        <span class="synConditional">unless</span> ( <span class="synIdentifier">$_-&gt;isa</span>(<span class="synString">'Moose::Meta::Role'</span>) ) {
            <span class="synStatement">require</span> Moose;
            Moose-&gt;throw_error(<span class="synString">&quot;The list of roles must be instances of Moose::Meta::Role, not </span><span class="synIdentifier">$_</span><span class="synString">&quot;</span>);
        }
    }

    <span class="synStatement">my</span> <span class="synIdentifier">@composition_roles</span> = <span class="synStatement">map</span> <span class="synStatement">{</span>
        <span class="synIdentifier">$_-&gt;composition_class_roles</span>
    <span class="synStatement">}</span> <span class="synIdentifier">@{</span> <span class="synIdentifier">$params{</span><span class="synString">roles</span><span class="synIdentifier">}</span> <span class="synIdentifier">}</span>;

    <span class="synConditional">if</span> (<span class="synIdentifier">@composition_roles</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">$meta</span> = Moose::Meta::Class-&gt;create_anon_class(
            <span class="synString">superclasses</span> =&gt; [ <span class="synIdentifier">$class</span> ],
            <span class="synString">roles</span>        =&gt; [ <span class="synIdentifier">@composition_roles</span> ],
            <span class="synString">cache</span>        =&gt; <span class="synNumber">1</span>,
        );
        <span class="synIdentifier">$class</span> = <span class="synIdentifier">$meta-&gt;name</span>;
    }

    <span class="synComment"># and the name is created from the</span>
    <span class="synComment"># roles if one has not been provided</span>
    <span class="synIdentifier">$params{</span><span class="synString">name</span><span class="synIdentifier">}</span> ||= (<span class="synStatement">join</span> <span class="synString">&quot;|&quot;</span> =&gt; <span class="synStatement">map</span> <span class="synStatement">{</span> <span class="synIdentifier">$_-&gt;name</span> <span class="synStatement">}</span> <span class="synIdentifier">@{$params{</span><span class="synString">roles</span><span class="synIdentifier">}}</span>);
    <span class="synIdentifier">$class-&gt;_new</span>(\<span class="synIdentifier">%params</span>);
}

<span class="synComment"># This is largely a copy of what's in Moose::Meta::Role (itself</span>
<span class="synComment"># largely a copy of Class::MOP::Class). However, we can't actually</span>
<span class="synComment"># call add_package_symbol, because there's no package into which to</span>
<span class="synComment"># add the symbol.</span>
<span class="synKeyword">sub </span><span class="synFunction">add_method </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$method_name</span>, <span class="synIdentifier">$method</span>) = <span class="synIdentifier">@_</span>;

    <span class="synConditional">unless</span> ( <span class="synOperator">defined</span> <span class="synIdentifier">$method_name</span> &amp;&amp; <span class="synIdentifier">$method_name</span> ) {
        Moose-&gt;throw_error(<span class="synString">&quot;You must define a method name&quot;</span>);
    }

    <span class="synStatement">my</span> <span class="synIdentifier">$body</span>;
    <span class="synConditional">if</span> (blessed(<span class="synIdentifier">$method</span>)) {
        <span class="synIdentifier">$body</span> = <span class="synIdentifier">$method-&gt;body</span>;
        <span class="synConditional">if</span> (<span class="synIdentifier">$method-&gt;package_name</span> <span class="synOperator">ne</span> <span class="synIdentifier">$self-&gt;name</span>) {
            <span class="synIdentifier">$method</span> = <span class="synIdentifier">$method-&gt;clone</span>(
                <span class="synString">package_name</span> =&gt; <span class="synIdentifier">$self-&gt;name</span>,
                <span class="synString">name</span>         =&gt; <span class="synIdentifier">$method_name</span>
            ) <span class="synConditional">if</span> <span class="synIdentifier">$method-&gt;can</span>(<span class="synString">'clone'</span>);
        }
    }
    <span class="synConditional">else</span> {
        <span class="synIdentifier">$body</span> = <span class="synIdentifier">$method</span>;
        <span class="synIdentifier">$method</span> = <span class="synIdentifier">$self-&gt;wrap_method_body</span>( <span class="synString">body</span> =&gt; <span class="synIdentifier">$body</span>, <span class="synString">name</span> =&gt; <span class="synIdentifier">$method_name</span> );
    }

    <span class="synIdentifier">$self-&gt;_method_map-&gt;{$method_name}</span> = <span class="synIdentifier">$method</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">get_method_list </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;
    <span class="synStatement">return</span> <span class="synStatement">keys</span> <span class="synIdentifier">%{</span> <span class="synIdentifier">$self-&gt;_method_map</span> <span class="synIdentifier">}</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_get_local_methods </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;
    <span class="synStatement">return</span> <span class="synStatement">values</span> <span class="synIdentifier">%{</span> <span class="synIdentifier">$self-&gt;_method_map</span> <span class="synIdentifier">}</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">has_method </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$method_name</span>) = <span class="synIdentifier">@_</span>;

    <span class="synStatement">return</span> <span class="synStatement">exists</span> <span class="synIdentifier">$self-&gt;_method_map-&gt;{$method_name}</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">get_method </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$method_name</span>) = <span class="synIdentifier">@_</span>;

    <span class="synStatement">return</span> <span class="synIdentifier">$self-&gt;_method_map-&gt;{$method_name}</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">apply_params </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$role_params</span>) = <span class="synIdentifier">@_</span>;
    load_class(<span class="synIdentifier">$self-&gt;application_role_summation_class</span>);

    <span class="synIdentifier">$self-&gt;application_role_summation_class-&gt;new</span>(
        <span class="synString">role_params</span> =&gt; <span class="synIdentifier">$role_params</span>,
    )-&gt;apply(<span class="synIdentifier">$self</span>);

    <span class="synStatement">return</span> <span class="synIdentifier">$self</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">reinitialize </span>{
    <span class="synStatement">my</span> ( <span class="synIdentifier">$class</span>, <span class="synIdentifier">$old_meta</span>, <span class="synIdentifier">@args</span> ) = <span class="synIdentifier">@_</span>;

    Moose-&gt;throw_error(
        <span class="synString">'Moose::Meta::Role::Composite instances can only be reinitialized from an existing metaclass instance'</span>
        )
        <span class="synConditional">if</span> !blessed <span class="synIdentifier">$old_meta</span>
            || !<span class="synIdentifier">$old_meta-&gt;isa</span>(<span class="synString">'Moose::Meta::Role::Composite'</span>);

    <span class="synStatement">my</span> <span class="synIdentifier">%existing_classes</span> = <span class="synStatement">map</span> <span class="synStatement">{</span> <span class="synIdentifier">$_</span> =&gt; <span class="synIdentifier">$old_meta-&gt;$_</span>() <span class="synStatement">}</span> <span class="synString">qw(</span>
<span class="synString">        application_role_summation_class</span>
<span class="synString">    )</span>;

    <span class="synStatement">return</span> <span class="synIdentifier">$old_meta-&gt;meta-&gt;clone_object</span>( <span class="synIdentifier">$old_meta</span>, <span class="synIdentifier">%existing_classes</span>, <span class="synIdentifier">@args</span> );
}

<span class="synNumber">1</span>;

<span class="synComment"># ABSTRACT: An object to represent the set of roles</span>

<span class="synComment">__END__</span>

<span class="synStatement">=pod</span>

<span class="synStatement">=head1</span><span class="synString"> NAME</span>

Moose::Meta::Role::Composite - An object to represent the set of roles

<span class="synStatement">=head1</span><span class="synString"> VERSION</span>

version 2.1005

<span class="synStatement">=head1</span><span class="synString"> DESCRIPTION</span>

A composite is a role that consists of a set of two or more roles.

The API of a composite role is almost identical to that of a regular
role.

<span class="synStatement">=head1</span><span class="synString"> INHERITANCE</span>

<span class="synIdentifier">C&lt;Moose::Meta::Role::Composite&gt;</span> is a subclass of <span class="synIdentifier">L&lt;Moose::Meta::Role&gt;</span>.

<span class="synStatement">=head2</span><span class="synString"> METHODS</span>

<span class="synStatement">=over</span> <span class="synNumber">4</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;&lt; Moose::Meta::Role::Composite-&gt;new(%options) &gt;&gt;</span>

This returns a new composite role object. It accepts the same
options as its parent class, with a few changes:

<span class="synStatement">=over</span> <span class="synNumber">8</span>

<span class="synStatement">=item</span><span class="synString"> * roles</span>

This option is an array reference containing a list of
<span class="synIdentifier">L&lt;Moose::Meta::Role&gt;</span> object. This is a required option.

<span class="synStatement">=item</span><span class="synString"> * name</span>

If a name is not given, one is generated from the roles provided.

<span class="synStatement">=item</span><span class="synString"> * apply_params(\%role_params)</span>

Creates a new RoleSummation role application with <span class="synIdentifier">C&lt;%role_params&gt;</span> and applies
the composite role to it. The RoleSummation role application class used is
determined by the composite role's <span class="synIdentifier">C&lt;application_role_summation_class&gt;</span>
attribute.

<span class="synStatement">=item</span><span class="synString"> * reinitialize($metaclass)</span>

Like <span class="synIdentifier">C&lt;&lt; Class::MOP::Package-&gt;reinitialize &gt;&gt;</span>, but doesn't allow passing a
string with the package name, as there is no real package for composite roles.

<span class="synStatement">=back</span>

<span class="synStatement">=back</span>

<span class="synStatement">=head1</span><span class="synString"> BUGS</span>

See <span class="synIdentifier">L&lt;Moose/BUGS&gt;</span> for details on reporting bugs.

<span class="synStatement">=head1</span><span class="synString"> AUTHOR</span>

Moose is maintained by the Moose Cabal, along with the help of many contributors. See <span class="synIdentifier">L&lt;Moose/CABAL&gt;</span> and <span class="synIdentifier">L&lt;Moose/CONTRIBUTORS&gt;</span> for details.

<span class="synStatement">=head1</span><span class="synString"> COPYRIGHT AND LICENSE</span>

This software is copyright (c) 2013 by Infinity Interactive, Inc..

This is free software; you can redistribute it and/or modify it under
the same terms as the Perl 5 programming language system itself.

<span class="synStatement">=cut</span>
</pre>

 </body>
</html>
