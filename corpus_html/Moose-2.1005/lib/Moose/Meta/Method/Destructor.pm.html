<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
 <head>
  <title>[untitled]</title>
  <link rel="stylesheet" type="text/css" href="../../t/vim_syntax.css" />
 </head>
 <body>

<pre>
<span class="synStatement">package</span><span class="synType"> Moose::Meta::Method::Destructor</span>;
<span class="synPreProc">BEGIN </span>{
  <span class="synIdentifier">$</span><span class="synType">Moose::Meta::Method::Destructor::</span><span class="synIdentifier">AUTHORITY</span> = <span class="synString">'cpan:STEVAN'</span>;
}
{
  <span class="synIdentifier">$</span><span class="synType">Moose::Meta::Method::Destructor::</span><span class="synIdentifier">VERSION</span> = <span class="synString">'2.1005'</span>;
}

<span class="synStatement">use strict</span>;
<span class="synStatement">use warnings</span>;

<span class="synStatement">use </span>Devel::GlobalDestruction ();
<span class="synStatement">use </span>Scalar::Util <span class="synString">'blessed'</span>, <span class="synString">'weaken'</span>;
<span class="synStatement">use </span>Try::Tiny;

<span class="synStatement">use base</span> <span class="synString">'Moose::Meta::Method'</span>,
         <span class="synString">'Class::MOP::Method::Inlined'</span>;

<span class="synKeyword">sub </span><span class="synFunction">new </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$class</span>   = <span class="synStatement">shift</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">%options</span> = <span class="synIdentifier">@_</span>;

    (<span class="synOperator">ref</span> <span class="synIdentifier">$options{</span><span class="synString">options</span><span class="synIdentifier">}</span> <span class="synOperator">eq</span> <span class="synString">'HASH'</span>)
        || <span class="synIdentifier">$class-&gt;throw_error</span>(<span class="synString">&quot;You must pass a hash of options&quot;</span>, <span class="synString">data</span> =&gt; <span class="synIdentifier">$options{</span><span class="synString">options</span><span class="synIdentifier">}</span>);

    (<span class="synIdentifier">$options{</span><span class="synString">package_name</span><span class="synIdentifier">}</span> &amp;&amp; <span class="synIdentifier">$options{</span><span class="synString">name</span><span class="synIdentifier">}</span>)
        || <span class="synIdentifier">$class-&gt;throw_error</span>(<span class="synString">&quot;You must supply the package_name and name parameters </span><span class="synIdentifier">$</span><span class="synType">Class::MOP::Method::</span><span class="synIdentifier">UPGRADE_ERROR_TEXT</span><span class="synString">&quot;</span>);

    <span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synOperator">bless</span> {
        <span class="synComment"># from our superclass</span>
        <span class="synString">'body'</span>                 =&gt; <span class="synOperator">undef</span>,
        <span class="synString">'package_name'</span>         =&gt; <span class="synIdentifier">$options{</span><span class="synString">package_name</span><span class="synIdentifier">}</span>,
        <span class="synString">'name'</span>                 =&gt; <span class="synIdentifier">$options{</span><span class="synString">name</span><span class="synIdentifier">}</span>,
        <span class="synComment"># ...</span>
        <span class="synString">'options'</span>              =&gt; <span class="synIdentifier">$options{</span><span class="synString">options</span><span class="synIdentifier">}</span>,
        <span class="synString">'definition_context'</span>   =&gt; <span class="synIdentifier">$options{</span><span class="synString">definition_context</span><span class="synIdentifier">}</span>,
        <span class="synString">'associated_metaclass'</span> =&gt; <span class="synIdentifier">$options{</span><span class="synString">metaclass</span><span class="synIdentifier">}</span>,
    } =&gt; <span class="synIdentifier">$class</span>;

    <span class="synComment"># we don't want this creating</span>
    <span class="synComment"># a cycle in the code, if not</span>
    <span class="synComment"># needed</span>
    weaken(<span class="synIdentifier">$self-&gt;{</span><span class="synString">'associated_metaclass'</span><span class="synIdentifier">}</span>);

    <span class="synIdentifier">$self-&gt;_initialize_body</span>;

    <span class="synStatement">return</span> <span class="synIdentifier">$self</span>;
}

<span class="synComment">## accessors</span>

<span class="synKeyword">sub </span><span class="synFunction">options              </span>{ (<span class="synStatement">shift</span>)-&gt;{<span class="synString">'options'</span>}              }

<span class="synComment">## method</span>

<span class="synKeyword">sub </span><span class="synFunction">is_needed </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$self</span>      = <span class="synStatement">shift</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$metaclass</span> = <span class="synStatement">shift</span>;

    ( blessed <span class="synIdentifier">$metaclass</span> &amp;&amp; <span class="synIdentifier">$metaclass-&gt;isa</span>(<span class="synString">'Class::MOP::Class'</span>) )
        || <span class="synIdentifier">$self-&gt;throw_error</span>(
        <span class="synString">&quot;The is_needed method expected a metaclass object as its arugment&quot;</span>);

    <span class="synStatement">return</span> <span class="synIdentifier">$metaclass-&gt;find_method_by_name</span>(<span class="synString">&quot;DEMOLISHALL&quot;</span>);
}

<span class="synKeyword">sub </span><span class="synFunction">initialize_body </span>{
    Carp::cluck(<span class="synString">'The initialize_body method has been made private.'</span>
        . <span class="synString">&quot; The public version is deprecated and will be removed in a future release.</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>);
    <span class="synStatement">shift</span>-&gt;_initialize_body;
}

<span class="synKeyword">sub </span><span class="synFunction">_initialize_body </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;
    <span class="synComment"># </span><span class="synTodo">TODO:</span>
    <span class="synComment"># the %options should also include a both</span>
    <span class="synComment"># a call 'initializer' and call 'SUPER::'</span>
    <span class="synComment"># options, which should cover approx 90%</span>
    <span class="synComment"># of the possible use cases (even if it</span>
    <span class="synComment"># requires some adaption on the part of</span>
    <span class="synComment"># the author, after all, nothing is free)</span>

    <span class="synStatement">my</span> <span class="synIdentifier">$class</span> = <span class="synIdentifier">$self-&gt;associated_metaclass-&gt;name</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">@source</span> = (
        <span class="synString">'sub {'</span>,
            <span class="synString">'my $self = shift;'</span>,
            <span class="synString">'return '</span> . <span class="synIdentifier">$self-&gt;_generate_fallback_destructor</span>(<span class="synString">'$self'</span>),
                <span class="synString">'if Scalar::Util::blessed($self) ne \''</span> . <span class="synIdentifier">$class</span> . <span class="synString">'\';'</span>,
            <span class="synIdentifier">$self-&gt;_generate_DEMOLISHALL</span>(<span class="synString">'$self'</span>),
            <span class="synString">'return;'</span>,
        <span class="synString">'}'</span>,
    );
    <span class="synStatement">warn</span> <span class="synStatement">join</span>(<span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>, <span class="synIdentifier">@source</span>) <span class="synConditional">if</span> <span class="synIdentifier">$self-&gt;options-&gt;{</span><span class="synString">debug</span><span class="synIdentifier">}</span>;

    <span class="synStatement">my</span> <span class="synIdentifier">$code</span> = try {
        <span class="synIdentifier">$self-&gt;_compile_code</span>(<span class="synString">source</span> =&gt; \<span class="synIdentifier">@source</span>);
    }
    catch {
        <span class="synStatement">my</span> <span class="synIdentifier">$source</span> = <span class="synStatement">join</span>(<span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>, <span class="synIdentifier">@source</span>);
        <span class="synIdentifier">$self-&gt;throw_error</span>(
            <span class="synString">&quot;Could not eval the destructor :</span><span class="synSpecial">\n\n</span><span class="synIdentifier">$source</span><span class="synSpecial">\n\n</span><span class="synString">because :</span><span class="synSpecial">\n\n</span><span class="synIdentifier">$_</span><span class="synString">&quot;</span>,
            <span class="synString">error</span> =&gt; <span class="synIdentifier">$_</span>,
            <span class="synString">data</span>  =&gt; <span class="synIdentifier">$source</span>,
        );
    };

    <span class="synIdentifier">$self-&gt;{</span><span class="synString">'body'</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$code</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_generate_fallback_destructor </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;
    <span class="synStatement">my</span> (<span class="synIdentifier">$inv</span>) = <span class="synIdentifier">@_</span>;

    <span class="synStatement">return</span> <span class="synIdentifier">$inv</span> . <span class="synString">'-&gt;Moose::Object::DESTROY(@_)'</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_generate_DEMOLISHALL </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$self</span> = <span class="synStatement">shift</span>;
    <span class="synStatement">my</span> (<span class="synIdentifier">$inv</span>) = <span class="synIdentifier">@_</span>;

    <span class="synStatement">my</span> <span class="synIdentifier">@methods</span> = <span class="synIdentifier">$self-&gt;associated_metaclass-&gt;find_all_methods_by_name</span>(<span class="synString">'DEMOLISH'</span>);
    <span class="synStatement">return</span> <span class="synConditional">unless</span> <span class="synIdentifier">@methods</span>;

    <span class="synStatement">return</span> (
        <span class="synString">'local $?;'</span>,
        <span class="synString">'my $igd = Devel::GlobalDestruction::in_global_destruction;'</span>,
        <span class="synString">'Try::Tiny::try {'</span>,
            (<span class="synStatement">map</span> <span class="synStatement">{</span> <span class="synIdentifier">$inv</span> . <span class="synString">'-&gt;'</span> . <span class="synIdentifier">$_-&gt;{</span><span class="synString">class</span><span class="synIdentifier">}</span> . <span class="synString">'::DEMOLISH($igd);'</span> <span class="synStatement">}</span> <span class="synIdentifier">@methods</span>),
        <span class="synString">'}'</span>,
        <span class="synString">'Try::Tiny::catch {'</span>,
            <span class="synString">'die $_;'</span>,
        <span class="synString">'};'</span>,
    );
}


<span class="synNumber">1</span>;

<span class="synComment"># ABSTRACT: Method Meta Object for destructors</span>

<span class="synComment">__END__</span>

<span class="synStatement">=pod</span>

<span class="synStatement">=head1</span><span class="synString"> NAME</span>

Moose::Meta::Method::Destructor - Method Meta Object for destructors

<span class="synStatement">=head1</span><span class="synString"> VERSION</span>

version 2.1005

<span class="synStatement">=head1</span><span class="synString"> DESCRIPTION</span>

This class is a subclass of <span class="synIdentifier">L&lt;Class::MOP::Method::Inlined&gt;</span> that
provides Moose-specific functionality for inlining destructors.

To understand this class, you should read the
<span class="synIdentifier">L&lt;Class::MOP::Method::Inlined&gt;</span> documentation as well.

<span class="synStatement">=head1</span><span class="synString"> INHERITANCE</span>

<span class="synIdentifier">C&lt;Moose::Meta::Method::Destructor&gt;</span> is a subclass of
<span class="synIdentifier">L&lt;Moose::Meta::Method&gt;</span> <span class="synIdentifier">I&lt;and&gt;</span> <span class="synIdentifier">L&lt;Class::MOP::Method::Inlined&gt;</span>.

<span class="synStatement">=head1</span><span class="synString"> METHODS</span>

<span class="synStatement">=over</span> <span class="synNumber">4</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;&lt; Moose::Meta::Method::Destructor-&gt;new(%options) &gt;&gt;</span>

This constructs a new object. It accepts the following options:

<span class="synStatement">=over</span> <span class="synNumber">8</span>

<span class="synStatement">=item</span><span class="synString"> * package_name</span>

The package for the class in which the destructor is being
inlined. This option is required.

<span class="synStatement">=item</span><span class="synString"> * name</span>

The name of the destructor method. This option is required.

<span class="synStatement">=item</span><span class="synString"> * metaclass</span>

The metaclass for the class this destructor belongs to. This is
optional, as it can be set later by calling C&lt;&lt;
<span class="synIdentifier">$metamethod</span>-&gt;attach_to_class &gt;&gt;.

<span class="synStatement">=back</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;&lt; Moose::Meta;:Method::Destructor-&gt;is_needed($metaclass) &gt;&gt;</span>

Given a <span class="synIdentifier">L&lt;Moose::Meta::Class&gt;</span> object, this method returns a boolean
indicating whether the class needs a destructor. If the class or any
of its parents defines a <span class="synIdentifier">C&lt;DEMOLISH&gt;</span> method, it needs a destructor.

<span class="synStatement">=back</span>

<span class="synStatement">=head1</span><span class="synString"> BUGS</span>

See <span class="synIdentifier">L&lt;Moose/BUGS&gt;</span> for details on reporting bugs.

<span class="synStatement">=head1</span><span class="synString"> AUTHOR</span>

Moose is maintained by the Moose Cabal, along with the help of many contributors. See <span class="synIdentifier">L&lt;Moose/CABAL&gt;</span> and <span class="synIdentifier">L&lt;Moose/CONTRIBUTORS&gt;</span> for details.

<span class="synStatement">=head1</span><span class="synString"> COPYRIGHT AND LICENSE</span>

This software is copyright (c) 2013 by Infinity Interactive, Inc..

This is free software; you can redistribute it and/or modify it under
the same terms as the Perl 5 programming language system itself.

<span class="synStatement">=cut</span>
</pre>

 </body>
</html>
